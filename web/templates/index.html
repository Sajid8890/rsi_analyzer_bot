<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor v27 (Modern UI)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #fff;
            --text-color: #1c1e21;
            --text-secondary-color: #606770;
            --border-color: #e5e7eb;
            --accent-color: #0a6cff;
            --danger-color: #dc2626;
            --warning-color: #f59e0b;
            --success-color: #16a34a;
            --body-max-width: 2800px;
            --market-table-max-height: 600px;
        }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: var(--body-max-width); margin: auto; }
        h1, h2 { color: var(--text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        h3 { margin-top: 25px; margin-bottom: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .card { background-color: var(--card-bg-color); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); text-align: left; white-space: nowrap; }
        th { background-color: #f7f8fa; font-weight: 600; }
        .controls-container { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; }
        .control-group { display: flex; align-items: center; gap: 6px; background: #f7f8fa; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; }
        .control-group > label { font-weight: 600; font-size: 14px; }
        .control-btn { font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        .pause-btn { background-color: #fef2f2; color: #991b1b; border-color: #fecaca; }
        .resume-btn { background-color: #f0fdf4; color: #14532d; border-color: #bbf7d0; }
        .control-status { width: 10px; height: 10px; border-radius: 50%; }
        .status-on { background-color: #22c55e; } .status-off { background-color: var(--danger-color); }
        .master-control { padding: 8px 16px; font-weight: bold; }
        .toggle-btn { font-weight: 600; cursor: pointer; padding: 8px 12px; border-radius: 6px; background: #e9ecef; border: none; margin-bottom: 10px; }
        .positive { color: var(--success-color); } .negative { color: var(--danger-color); }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; color: #fff; position: relative; }
        .status-trading-bot { background-color: #7c3aed; }
        .status-trading-manual { background-color: var(--success-color); }
        .status-trading-live { background-color: #f59e0b; }
        .status-cooldown { background-color: #71717a; cursor: help; }
        .action-btn { color: white; border: none; padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .manual-trade-btn { background-color: var(--accent-color); }
        .manual-close-btn { background-color: var(--danger-color); }
        .add-cooldown-btn { background-color: var(--warning-color); }
        .remove-cooldown-btn { background-color: #10b981; }
        .discard-btn { background-color: #64748b; }
        .timers { display: flex; gap: 20px; margin-bottom: 15px; font-size: 14px; }
        .timer-box { background: #f7f8fa; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card { background-color: var(--card-bg-color); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .label { font-size: 14px; color: var(--text-secondary-color); margin-top: 5px; }
        .coin-link { text-decoration: none; color: var(--accent-color); font-weight: 600; }
        .hidden { display: none; }
        #config-grid, #style-config-grid, #ui-config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-size: 12px; color: var(--text-secondary-color); margin-bottom: 4px; font-weight: 600; }
        .config-item input, .config-item select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
        #market-data-container { max-height: var(--market-table-max-height); overflow-y: auto; position: relative; }
        #market-data-container thead { position: sticky; top: 0; z-index: 1; }
        .bottom-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        #master-reset-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .reset-btn { width: 100%; padding: 10px; border: 1px solid var(--danger-color); background-color: #fff5f5; color: var(--danger-color); font-weight: bold; border-radius: 5px; cursor: pointer; }
        .modern-stat-card { display: flex; flex-direction: column; height: 100%; }
        .modern-stat-card .card-content { flex-grow: 1; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .stat-item:last-child { border-bottom: none; }
        .stat-item .label { color: var(--text-secondary-color); }
        .stat-item .value { font-weight: 600; font-size: 15px; }
        #alert-log { list-style: none; padding: 0; margin: 0; font-size: 13px; }
        #alert-log li { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        #alert-log li:last-child { border-bottom: none; }
        .db-container { overflow-x: auto; }
        .table-section-header { background-color: #eef2ff; font-weight: bold; }
        .table-section-header td { padding-top: 16px; padding-bottom: 16px; }
        #trade-config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: flex-end; }
        .trade-setting-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Monitor v27 (Modern UI)</h1>
        <div id="global-pause-notice" class="global-pause-notice" style="display: none; background-color: var(--warning-color); color: white; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 15px; font-weight: bold;">...</div>
        
        <button class="toggle-btn" onclick="toggleCardVisibility('top-stats-grid', this)">Hide Portfolio Stats</button>
        <div id="top-stats-grid" class="card stats-grid">
            <div class="stat-card"><div class="value" id="stat-portfolio-value">$0.00</div><div class="label">Total Portfolio Value</div></div>
            <div class="stat-card"><div class="value" id="stat-portfolio-in-trades">$0.00</div><div class="label">Amount in Trades</div></div>
            <div class="stat-card"><div class="value" id="stat-portfolio-available">$0.00</div><div class="label">Available Funds</div></div>
            <div class="stat-card"><div class="value" id="stat-open-trades">0 / 0</div><div class="label">Open Trades</div></div>
            <div class="stat-card"><div class="value" id="stat-hot-coins">0</div><div id="hot-coins-label" class="label">Hot Coins</div></div>
            <div class="stat-card"><div class="value" id="stat-cooldown">0</div><div class="label">In Cooldown</div></div>
        </div>

        <div class="card">
            <h2>Global Controls</h2>
            <div class="controls-container">
                <div class="control-group">
                    <button id="master-pause" class="control-btn pause-btn master-control">PAUSE ALL</button>
                    <button id="master-resume" class="control-btn resume-btn master-control">RESUME ALL</button>
                </div>
                <div class="control-group">
                    <button id="refresh-coin-list" class="control-btn" style="background-color: #e0f2fe; color: #075985; border-color: #bae6fd; font-weight: bold;">Refresh Coin List</button>
                    <span id="refresh-status" style="font-size: 12px; margin-left: 5px;"></span>
                </div>
                <div class="control-group">
                    <button id="refresh-balance" class="control-btn" style="background-color: #f0fdf4; color: #14532d; border-color: #bbf7d0; font-weight: bold;">Refresh Balance</button>
                    <span id="balance-status" style="font-size: 12px; margin-left: 5px;"></span>
                </div>
                <div class="control-group"><div id="status-websocket_enabled" class="control-status"></div><label>WebSocket</label><button class="control-btn pause-btn" onclick="toggleControl('websocket_enabled', 'pause')">Pause</button><button class="control-btn resume-btn" onclick="toggleControl('websocket_enabled', 'resume')">Resume</button></div>
                <div class="control-group"><div id="status-rsi_enabled" class="control-status"></div><label>RSI</label><button class="control-btn pause-btn" onclick="toggleControl('rsi_enabled', 'pause')">Pause</button><button class="control-btn resume-btn" onclick="toggleControl('rsi_enabled', 'resume')">Resume</button></div>
                <div class="control-group">
                    <div id="status-trade_execution_enabled" class="control-status"></div>
                    <label>Trade Execution</label>
                    <button class="control-btn pause-btn" onclick="toggleControl('trade_execution_enabled', 'pause')">Pause</button>
                    <button class="control-btn resume-btn" onclick="toggleControl('trade_execution_enabled', 'resume')">Resume</button>
                </div>
                <div class="control-group"><div id="status-email_enabled" class="control-status"></div><label>Email</label><button class="control-btn pause-btn" onclick="toggleControl('email_enabled', 'pause')">Pause</button><button class="control-btn resume-btn" onclick="toggleControl('email_enabled', 'resume')">Resume</button></div>
            </div>
        </div>

        <button class="toggle-btn" onclick="toggleCardVisibility('config-card', this)">Show Configuration</button>
        <div id="config-card" class="card hidden">
            <h2>Bot & Style Configuration</h2>
            <p style="font-size: 12px; color: var(--text-secondary-color);">Changes are saved permanently to the config file.</p>
            
            <h3>Trade Settings</h3>
            <div id="trade-config-grid">
                <div class="trade-setting-group">
                    <label>Trade Amount Type</label>
                    <div class="radio-group">
                        <label><input type="radio" name="TRADE_AMOUNT_TYPE" value="fixed_usdt"> Fixed USDT</label>
                        <label><input type="radio" name="TRADE_AMOUNT_TYPE" value="percentage"> Percentage</label>
                    </div>
                    <div id="trade-amount-inputs"></div>
                </div>
                <div class="trade-setting-group">
                    <div class="config-item">
                        <label for="config-TAKE_PROFIT_PERCENT">TAKE_PROFIT_PERCENT</label>
                        <input type="text" id="config-TAKE_PROFIT_PERCENT" name="TAKE_PROFIT_PERCENT">
                    </div>
                </div>
            </div>

            <h3>Core Bot Settings</h3>
            <div id="config-grid"></div>
            
            <h3>UI Settings</h3>
            <div id="ui-config-grid">
                <div class="config-item">
                    <label for="config-HIDE_COOLDOWN_DETAILS">HIDE_COOLDOWN_DETAILS</label>
                    <select id="config-HIDE_COOLDOWN_DETAILS" name="HIDE_COOLDOWN_DETAILS">
                        <option value="True">True (Hide Price/RSI)</option>
                        <option value="False">False (Show All)</option>
                    </select>
                </div>
            </div>

            <h3>Style & Portfolio</h3>
            <div id="style-config-grid"></div>

            <div id="config-actions" style="margin-top: 20px;">
                <button id="config-save-btn" style="background-color: var(--accent-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Save Config</button>
                <span id="config-status"></span>
            </div>
        </div>

        <button class="toggle-btn" onclick="toggleCardVisibility('master-reset-card', this)">Show Master Controls</button>
        <div id="master-reset-card" class="card hidden">
            <h2>Master Reset Controls</h2>
            <div id="master-reset-grid">
                <button class="reset-btn" onclick="handleMasterReset('close_all_trades')">Close All Trades</button>
                <button class="reset-btn" onclick="handleMasterReset('discard_trades')">Discard All Trades</button>
                <button class="reset-btn" onclick="handleMasterReset('remove_cooldowns')">Remove All Cooldowns</button>
                <button class="reset-btn" onclick="handleMasterReset('reset_global_stats')">Reset Global Stats</button>
                <button class="reset-btn" onclick="handleMasterReset('reset_database')">DELETE Databases</button>
            </div>
            <p id="master-reset-status" style="margin-top: 10px; font-weight: bold;"></p>
        </div>
        <div class="timers">
            <div class="timer-box">RSI Status: <b id="rsi-status-text">Initializing...</b></div>
            <div class="timer-box">UI Refresh: <b id="ui-timer">1s</b></div>
            <div class="timer-box">Bot Uptime: <b id="bot-uptime">0:00:00</b></div>
        </div>
        
        <div id="live-market-card" class="card" style="width: 100%; box-sizing: border-box; transition: border 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px;">
                <h2>Live Market Data</h2>
                <select id="sort-by-select" style="padding: 5px; border-radius: 4px;">
                    <option value="change_24h">Sort By: 24h Change</option>
                    <option value="rsi" selected>Sort By: 1h RSI</option>
                </select>
            </div>
            <div id="market-data-container">
                <table id="market-table">
                    <thead><tr><th>Symbol</th><th>Status</th><th>Current Price</th><th>Entry Price</th><th>PNL (%)</th><th>PNL (USDT)</th><th>24h Change</th><th>1h RSI</th><th>Action</th></tr></thead>
                    <tbody id="market-table-body"><tr><td colspan="9" style="text-align:center;">Initializing...</td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="bottom-cards-container">
            <div class="modern-stat-card">
                <button class="toggle-btn" onclick="toggleCardVisibility('events-card', this)">Hide Recent Events</button>
                <div id="events-card" class="card card-content">
                    <h2>Recent Events</h2>
                    <div id="alert-log-container" style="max-height: 250px; overflow-y: auto;">
                        <ul id="alert-log"></ul>
                    </div>
                </div>
            </div>
            <div class="modern-stat-card">
                <button class="toggle-btn" onclick="toggleCardVisibility('stats-24h-card', this)">Hide 24h Stats</button>
                <div id="stats-24h-card" class="card card-content">
                    <h2>24h Stats</h2>
                    <div id="stats-24h-container">
                        <div class="stat-item"><span class="label">24h P/L</span><span class="value" id="stat-24h-pl">$0.00</span></div>
                        <div class="stat-item"><span class="label">24h Trades</span><span class="value" id="stat-24h-count">0</span></div>
                        <div class="stat-item"><span class="label">Success</span><span class="value positive" id="stat-24h-success">0</span></div>
                        <div class="stat-item"><span class="label">Failed</span><span class="value negative" id="stat-24h-failed">0</span></div>
                    </div>
                </div>
            </div>
            <div class="modern-stat-card">
                <button class="toggle-btn" onclick="toggleCardVisibility('global-stats-card', this)">Hide Global Stats</button>
                <div id="global-stats-card" class="card card-content">
                    <h2>Global Stats</h2>
                    <div id="global-stats-container">
                        <div class="stat-item"><span class="label">Total Profit</span><span class="value positive" id="stat-global-profit">$0.00</span></div>
                        <div class="stat-item"><span class="label">Total Loss</span><span class="value negative" id="stat-global-loss">$0.00</span></div>
                        <div class="stat-item"><span class="label">Net Profit</span><span class="value" id="stat-net-profit">$0.00</span></div>
                        <div class="stat-item"><span class="label">Win Rate</span><span class="value" id="stat-win-rate">0%</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="toggle-btn" onclick="toggleCardVisibility('trade-db-container', this)">Hide Paper Trade Database</button>
            <div id="trade-db-container" class="card db-container">
                <h2>Paper Trade Database</h2>
                <table id="db-table">
                    <thead><tr><th>Alert #</th><th>Timestamp</th><th>Exit Time</th><th>Duration (H)</th><th>Symbol</th><th>Type</th><th>Status</th><th>Reason</th><th>Entry Price</th><th>Exit Price</th><th>PNL (%)</th><th>PNL (USDT)</th><th>Entry RSI</th><th>Exit RSI</th><th>Trade Amount</th><th>Leverage</th><th>Source</th><th>Cooldown Trigger</th><th>Max Neg PNL %</th><th>Max Neg PNL ($)</th><th>Max Neg RSI</th></tr></thead>
                    <tbody id="db-table-body"><tr><td colspan="21" style="text-align:center;">Initializing...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- NEW COOLDOWN DATABASE TABLE -->
        <div style="margin-top: 20px;">
            <button class="toggle-btn" onclick="toggleCardVisibility('cooldown-db-container', this)">Hide Cooldown Database</button>
            <div id="cooldown-db-container" class="card db-container">
                <h2>Cooldown Database</h2>
                <table id="cooldown-db-table">
                    <thead><tr><th>Coin Name</th><th>Entry Date</th><th>Expected Exit Date</th><th>Reason of Cooldown</th></tr></thead>
                    <tbody id="cooldown-db-table-body"><tr><td colspan="4" style="text-align:center;">Initializing...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
let RSI_HOT_COIN_THRESHOLD = 10;
let HIDE_COOLDOWN_DETAILS = true;
let currentSortBy = 'rsi';

function applyStyles(styles) {
    document.documentElement.style.setProperty('--body-max-width', styles.body_max_width);
    document.documentElement.style.setProperty('--market-table-max-height', styles.market_table_max_height);
}

function updateDynamicStyles(control_status) {
    const marketCard = document.getElementById('live-market-card');
    if (marketCard && control_status) {
        if (control_status.trade_execution_enabled) {
            marketCard.style.border = '2px solid var(--success-color)';
        } else {
            marketCard.style.border = '2px solid var(--border-color)';
        }
    }
}

function formatPrice(price) {
    if (price === null || price === undefined || price === '') return '-';
    price = parseFloat(price);
    if (price < 0.01) return price.toFixed(8);
    return price.toFixed(4);
}

function formatTimeRemaining(endTime) {
    const totalSeconds = endTime - (Date.now() / 1000);
    if (totalSeconds <= 0) return "Ending soon";
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    let parts = [];
    if (days > 0) parts.push(`${days}D`);
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    return `Ends in: ${parts.join(', ')}`;
}

async function fetchData() {
    try {
        const res = await fetch('/data');
        if (!res.ok) { console.error("Failed to fetch /data"); return; }
        
        const data = await res.json();
        const { market_data, rsi_values, rsi_status, statistics, control_status, portfolio, styles, hide_cooldown_details } = data;

        if (styles) applyStyles(styles);
        HIDE_COOLDOWN_DETAILS = hide_cooldown_details;

        if (statistics) {
            RSI_HOT_COIN_THRESHOLD = statistics.hot_coin_threshold || 10;
            document.getElementById('stat-hot-coins').textContent = statistics.hot_coins;
            document.getElementById('hot-coins-label').textContent = `Hot Coins (>${RSI_HOT_COIN_THRESHOLD}%)`;
            document.getElementById('stat-open-trades').textContent = `${statistics.open_trades} / ${statistics.max_trades}`;
            document.getElementById('stat-cooldown').textContent = statistics.cooldown_coins;
            document.getElementById('bot-uptime').textContent = statistics.bot_uptime;

            const stats = statistics.global_stats;
            const netProfit = stats.global_profit_usdt - stats.global_loss_usdt;
            document.getElementById('stat-global-profit').textContent = `$${stats.global_profit_usdt.toFixed(2)}`;
            document.getElementById('stat-global-loss').textContent = `$${stats.global_loss_usdt.toFixed(2)}`;
            document.getElementById('stat-net-profit').textContent = `$${netProfit.toFixed(2)}`;
            document.getElementById('stat-net-profit').className = `value ${netProfit >= 0 ? 'positive' : 'negative'}`;
            const totalTrades = stats.profitable_trades + stats.loss_trades;
            document.getElementById('stat-win-rate').textContent = totalTrades > 0 ? `${((stats.profitable_trades / totalTrades) * 100).toFixed(1)}%` : '0%';
            
            const stats24h = statistics.stats_24h;
            if (stats24h) {
                const pl24h = stats24h.profit_loss;
                document.getElementById('stat-24h-pl').textContent = `$${pl24h.toFixed(2)}`;
                document.getElementById('stat-24h-pl').className = `value ${pl24h >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('stat-24h-count').textContent = stats24h.trade_count;
                document.getElementById('stat-24h-success').textContent = stats24h.success_trades;
                document.getElementById('stat-24h-failed').textContent = stats24h.failed_trades;
            }
        }
        
        if (portfolio) {
            document.getElementById('stat-portfolio-value').textContent = `$${portfolio.total_value.toFixed(2)}`;
            document.getElementById('stat-portfolio-in-trades').textContent = `$${portfolio.in_trades.toFixed(2)}`;
            document.getElementById('stat-portfolio-available').textContent = `$${portfolio.available.toFixed(2)}`;
        }

        document.getElementById('rsi-status-text').textContent = rsi_status.message || '...';

        if (control_status) {
            for (const [key, is_on] of Object.entries(control_status)) {
                const statusEl = document.getElementById(`status-${key}`);
                if (statusEl) statusEl.className = `control-status ${is_on ? 'status-on' : 'status-off'}`;
            }
            const globalPauseNotice = document.getElementById('global-pause-notice');
            if (control_status.global_pause_active) {
                globalPauseNotice.textContent = "GLOBAL PAUSE ACTIVE: Trading is disabled due to high losses. It will resume automatically.";
                globalPauseNotice.style.display = 'block';
            } else {
                globalPauseNotice.style.display = 'none';
            }
            updateDynamicStyles(control_status);
        }

        renderMarketTable(market_data, rsi_values, rsi_status);

        const alertsRes = await fetch('/alerts');
        const alertLogData = await alertsRes.json();
        document.getElementById('alert-log').innerHTML = alertLogData.map(alert => `<li>[${alert.time}] <b>${alert.symbol}</b> - ${alert.rsi}</li>`).join('');

    } catch (error) { console.error("Error in fetchData:", error); }
}

function renderMarketTable(market_data, rsi_values, rsi_status) {
    const tableBody = document.getElementById('market-table-body');
    tableBody.innerHTML = '';

    if (!market_data || market_data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Waiting for WebSocket data...</td></tr>`;
        return;
    }

    const groups = { trading: [], cooldown: [], hot: [] };
    market_data.forEach(coin => {
        if (coin.status.startsWith('trading')) groups.trading.push(coin);
        else if (coin.status === 'cooldown') groups.cooldown.push(coin);
        else if (coin.change_24h >= RSI_HOT_COIN_THRESHOLD) groups.hot.push(coin);
    });

    groups.trading.sort((a, b) => b.pnl - a.pnl);
    groups.cooldown.sort((a, b) => b.change_24h - a.change_24h);
    groups.hot.sort((a, b) => (currentSortBy === 'rsi') ? (rsi_values[b.symbol] || 0) - (rsi_values[a.symbol] || 0) : b.change_24h - a.change_24h);

    let rowsAdded = 0;
    const renderGroup = (coins, groupName) => {
        if (coins.length === 0) return;
        
        const headerRow = document.createElement('tr');
        headerRow.className = 'table-section-header';
        headerRow.innerHTML = `<td colspan="9">${groupName} (${coins.length})</td>`;
        tableBody.appendChild(headerRow);

        rowsAdded += coins.length;
        coins.forEach(coin => {
            const row = document.createElement('tr');
            let statusBadge = '', actionButtons = '';
            
            const isCooldown = coin.status === 'cooldown';
            const hideDetails = isCooldown && HIDE_COOLDOWN_DETAILS;

            if (coin.status.startsWith('trading')) {
                const source = coin.status.split('-')[1];
                statusBadge = `<span class="status-badge status-trading-${source}">${source.toUpperCase()}</span>`;
                actionButtons = `<button class="action-btn manual-close-btn" onclick="manualCloseTrade('${coin.symbol}')">Close</button><button class="action-btn discard-btn" onclick="discardTrade('${coin.symbol}')">Discard</button>`;
            } else if (isCooldown) {
                const timeRemaining = coin.cooldown_end_time ? formatTimeRemaining(coin.cooldown_end_time) : '';
                statusBadge = `<span class="status-badge status-cooldown" title="${timeRemaining}">Cooldown (${coin.status_reason})</span>`;
                actionButtons =                `<button class="action-btn remove-cooldown-btn" onclick="removeCooldown('${coin.symbol}')">Remove</button>`;
            } else {
                statusBadge = '<span class="status-badge" style="background-color: #ccc;">Available</span>';
                actionButtons = `<button class="action-btn manual-trade-btn" onclick="manualTrade('${coin.symbol}', ${coin.price})">Trade</button><button class="action-btn add-cooldown-btn" onclick="addManualCooldown('${coin.symbol}')">Cooldown</button>`;
            }
            const pnl = coin.pnl, pnlUsdt = coin.pnl_usdt;
            const rsi = rsi_values[coin.symbol];
            row.innerHTML = `
                <td><a href="https://www.binance.com/en/futures/${coin.symbol}" target="_blank" class="coin-link">${coin.symbol}</a></td>
                <td>${statusBadge}</td>
                <td>${hideDetails ? '-' : `$${formatPrice(coin.price )}`}</td>
                <td>${coin.entry_price !== null ? `$${formatPrice(coin.entry_price)}` : '-'}</td>
                <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl !== null ? `${pnl.toFixed(2)}%` : '-'}</td>
                <td class="${pnlUsdt >= 0 ? 'positive' : 'negative'}">${pnlUsdt !== null ? `$${pnlUsdt.toFixed(3)}` : '-'}</td>
                <td class="${coin.change_24h >= 0 ? 'positive' : 'negative'}">${hideDetails ? '-' : `${coin.change_24h.toFixed(2)}%`}</td>
                <td class="${(rsi || 0) >= 80 ? 'positive' : ''}">${hideDetails ? '-' : (rsi !== undefined ? (typeof rsi === 'number' ? rsi.toFixed(2) : rsi) : '...')}</td>
                <td>${actionButtons}</td>`;
            tableBody.appendChild(row);
        });
    };
    
    renderGroup(groups.trading, "Active Trades"); 
    renderGroup(groups.cooldown, "On Cooldown"); 
    renderGroup(groups.hot, "Hot Coins (Monitoring)");

    if (rowsAdded === 0) tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No coins meet criteria.</td></tr>`;
}

async function fetchDatabase() {
    try {
        const response = await fetch('/database');
        const dbData = await response.json();
        const tableBody = document.getElementById('db-table-body');
        tableBody.innerHTML = '';
        if (!dbData || dbData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="21" style="text-align:center;">Database is empty.</td></tr>`;
            return;
        }
        dbData.forEach(row => {
            const tr = document.createElement('tr');
            const triggerValue = row.Cooldown_Trigger_Value ? `${parseFloat(row.Cooldown_Trigger_Value).toFixed(2)}%` : '';
            const symbolLink = `<a href="https://www.binance.com/en/futures/${row.Symbol}" target="_blank" class="coin-link">${row.Symbol}</a>`;
            tr.innerHTML = `
                <td>${row['Alert #']}</td><td>${row.Timestamp}</td><td>${row['Exit Time']}</td><td>${row['Duration (H )']}</td>
                <td>${symbolLink}</td><td>${row.Type}</td><td>${row.Status}</td><td>${row.Reason}</td>
                <td>${formatPrice(row['Entry Price'])}</td><td>${formatPrice(row['Exit Price'])}</td>
                <td class="${parseFloat(row['PNL (%)']) >= 0 ? 'positive' : 'negative'}">${row['PNL (%)']}</td>
                <td class="${parseFloat(row['PNL (USDT)']) >= 0 ? 'positive' : 'negative'}">${formatPrice(row['PNL (USDT)'])}</td>
                <td>${row['Entry RSI']}</td><td>${row['Exit RSI']}</td><td>${formatPrice(row['Trade Amount'])}</td>
                <td>${row['Leverage']}</td><td>${row.Source || 'Bot'}</td><td>${triggerValue}</td>
                <td class="negative">${row['Max Neg PNL %'] || ''}</td>
                <td class="negative">${row['Max Neg PNL ($)'] || ''}</td>
                <td>${row['Max Neg RSI'] || ''}</td>
            `;
            tableBody.appendChild(tr);
        });
    } catch (e) { console.error("Error in fetchDatabase:", e); }
}

// --- NEW FUNCTION TO FETCH COOLDOWN DATABASE ---
async function fetchCooldownDatabase() {
    try {
        const response = await fetch('/cooldown-database');
        const dbData = await response.json();
        const tableBody = document.getElementById('cooldown-db-table-body');
        tableBody.innerHTML = '';
        if (!dbData || dbData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Cooldown database is empty.</td></tr>`;
            return;
        }
        dbData.forEach(row => {
            const tr = document.createElement('tr');
            const symbolLink = `<a href="https://www.binance.com/en/futures/${row['Coin Name']}" target="_blank" class="coin-link">${row['Coin Name']}</a>`;
            tr.innerHTML = `
                <td>${symbolLink}</td>
                <td>${row['Entry Date']}</td>
                <td>${row['Expected Exit Date']}</td>
                <td>${row['Reason of Cooldown']}</td>
            `;
            tableBody.appendChild(tr );
        });
    } catch (e) { console.error("Error in fetchCooldownDatabase:", e); }
}

async function toggleControl(control, action) {
    await fetch('/toggle-control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ control, action }) });
    fetchData();
}

async function manualTrade(symbol, currentPrice) {
    const entryPrice = prompt(`Enter entry price for ${symbol}:`, currentPrice.toFixed(8));
    if (entryPrice === null || isNaN(parseFloat(entryPrice))) return;
    await fetch('/manual-trade', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ symbol, entry_price: entryPrice }) });
    fetchData(); fetchDatabase();
}

async function manualCloseTrade(symbol) {
    if (!confirm(`Close trade for ${symbol}? For LIVE trades, this only updates the bot's UI. You must close on Binance.`)) return;
    await fetch(`/manual-close/${symbol}`, { method: 'POST' });
    fetchData(); fetchDatabase(); fetchCooldownDatabase();
}

async function discardTrade(symbol) {
    if (!confirm(`DISCARD trade for ${symbol}? This is irreversible.`)) return;
    await fetch(`/discard-trade/${symbol}`, { method: 'POST' });
    fetchData(); fetchDatabase(); fetchCooldownDatabase();
}

async function addManualCooldown(symbol) {
    const hours = prompt(`Enter cooldown hours for ${symbol}:`, "48");
    if (hours === null || isNaN(parseFloat(hours))) return;
    await fetch('/set-cooldown', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ symbol, hours: parseFloat(hours) }) });
    fetchData(); fetchCooldownDatabase();
}

async function removeCooldown(symbol) {
    if (!confirm(`Remove cooldown for ${symbol}?`)) return;
    await fetch(`/remove-cooldown/${symbol}`, { method: 'POST' });
    fetchData(); fetchCooldownDatabase();
}

async function fetchConfig() {
    try {
        const response = await fetch('/get-config');
        const config = await response.json();
        
        const configGrid = document.getElementById('config-grid');
        const styleGrid = document.getElementById('style-config-grid');
        const tradeAmountInputsContainer = document.getElementById('trade-amount-inputs');

        configGrid.innerHTML = ''; 
        styleGrid.innerHTML = '';
        tradeAmountInputsContainer.innerHTML = '';

        const botConfigs = [
            "RSI_HOT_COIN_THRESHOLD", "RSI_LENGTH", "RSI_ALERT_THRESHOLD", 
            "MAX_OPEN_TRADES", "LEVERAGE", "TRADE_CLOSE_RSI", "TRADE_STAY_OPEN_HOURS", 
            "DEFAULT_COOLDOWN_PERIOD", "LOSS_TRADES_LIMIT_24H", "GLOBAL_PAUSE_DURATION_HOURS",
            "STALE_SIGNAL_LOOKBACK_HOURS", "STALE_SIGNAL_PULLBACK_PERCENT",
            "ATH_PULLBACK_THRESHOLD_PERCENT", "NEW_COIN_COOLDOWN_DAYS"
        ];
        const styleConfigs = { 
            "portfolio_balance": "Portfolio Balance ($)", 
            "body_max_width": "Page Max Width (px, %)", 
            "market_table_max_height": "Market Table Max Height (px)" 
        };

        const createInput = (key, value, grid) => {
            const item = document.createElement('div');
            item.className = 'config-item';
            item.innerHTML = `<label for="config-${key}">${key}</label><input type="text" id="config-${key}" name="${key}" value="${value}">`;
            grid.appendChild(item);
        };

        document.querySelector(`input[name="TRADE_AMOUNT_TYPE"][value="${config.TRADE_AMOUNT_TYPE}"]`).checked = true;
        document.getElementById('config-TAKE_PROFIT_PERCENT').value = config.TAKE_PROFIT_PERCENT;
        
        const updateTradeAmountInputs = () => {
            const selectedType = document.querySelector('input[name="TRADE_AMOUNT_TYPE"]:checked').value;
            tradeAmountInputsContainer.innerHTML = '';
            if (selectedType === 'fixed_usdt') {
                createInput('TRADE_AMOUNT_FIXED_USDT', config.TRADE_AMOUNT_FIXED_USDT, tradeAmountInputsContainer);
            } else {
                createInput('TRADE_AMOUNT_PERCENTAGE', config.TRADE_AMOUNT_PERCENTAGE, tradeAmountInputsContainer);
            }
        };
        
        document.querySelectorAll('input[name="TRADE_AMOUNT_TYPE"]').forEach(radio => {
            radio.addEventListener('change', updateTradeAmountInputs);
        });
        
        updateTradeAmountInputs();

        botConfigs.forEach(key => {
            if (config[key] !== undefined) createInput(key, config[key], configGrid);
        });
        for (const [key, label] of Object.entries(styleConfigs)) {
            if (config[key] !== undefined) {
                 const item = document.createElement('div');
                 item.className = 'config-item';
                 item.innerHTML = `<label for="config-${key}">${label}</label><input type="text" id="config-${key}" name="${key}" value="${config[key]}">`;
                 styleGrid.appendChild(item);
            }
        }
        
        if (config.HIDE_COOLDOWN_DETAILS !== undefined) {
            document.getElementById('config-HIDE_COOLDOWN_DETAILS').value = config.HIDE_COOLDOWN_DETAILS ? 'True' : 'False';
        }

    } catch (e) { console.error("Failed to fetch config:", e); }
}

async function saveConfig() {
    const configStatus = document.getElementById('config-status');
    configStatus.textContent = 'Saving...';
    const newConfig = {};
    
    document.querySelectorAll('#trade-config-grid input, #config-grid input, #style-config-grid input, #ui-config-grid select').forEach(input => { 
        if (input.type === 'radio') {
            if (input.checked) {
                newConfig[input.name] = input.value;
            }
        } else {
            newConfig[input.name] = input.value;
        }
    });
    
    try {
        const response = await fetch('/update-config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newConfig) });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);
        
        configStatus.textContent = `✅ ${result.message}`;
        setTimeout(() => {
            configStatus.textContent = '';
            fetchConfig(); 
        }, 3000);
        fetchData();
    } catch (e) { 
        configStatus.textContent = `Error: ${e.message}`; 
    }
}

async function handleMasterReset(action) {
    const confirmations = {
        discard_trades: "DISCARD all open trades?",
        remove_cooldowns: "REMOVE all cooldowns?",
        close_all_trades: "CLOSE all open trades at market price?",
        reset_global_stats: "RESET all global profit/loss stats to zero?",
        reset_database: "DELETE the entire trade and cooldown database files? THIS CANNOT BE UNDONE.",
    };
    if (!confirm(`Are you sure you want to ${confirmations[action]}`)) return;

    const statusEl = document.getElementById('master-reset-status');
    statusEl.textContent = 'Processing...';
    try {
        const response = await fetch('/master-reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action }) });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);
        statusEl.textContent = `✅ ${result.message}`;
        fetchData();
        fetchDatabase();
        fetchCooldownDatabase();
        if (action === 'reset_database') fetchConfig();
    } catch (e) { 
        statusEl.textContent = `Error: ${e.message}`; 
    }
}

function toggleCardVisibility(cardId, btn) {
    const card = document.getElementById(cardId);
    card.classList.toggle('hidden');
    btn.textContent = card.classList.contains('hidden') ? btn.textContent.replace('Hide', 'Show') : btn.textContent.replace('Show', 'Hide');
}

async function refreshCoinList() {
    const statusEl = document.getElementById('refresh-status');
    statusEl.textContent = 'Refreshing...';
    try {
        const response = await fetch('/refresh-coin-list', { method: 'POST' });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);
        statusEl.textContent = `✅ ${result.message}`;
        setTimeout(() => { statusEl.textContent = ''; }, 4000);
    } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
    }
}

async function refreshBalance() {
    const statusEl = document.getElementById('balance-status');
    statusEl.textContent = 'Refreshing...';
    try {
        const response = await fetch('/refresh-balance', { method: 'POST' });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);
        statusEl.textContent = `✅ ${result.message}`;
        setTimeout(() => { statusEl.textContent = ''; fetchData(); }, 2000);
    } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    fetchDatabase();
    fetchCooldownDatabase(); // <-- Call the new function on load
    fetchConfig();
    setInterval(fetchData, 1000); 
    setInterval(fetchDatabase, 30000);
    setInterval(fetchCooldownDatabase, 30000); // <-- Call the new function periodically

    document.getElementById('sort-by-select').addEventListener('change', (e) => { currentSortBy = e.target.value; fetchData(); });
    document.getElementById('config-save-btn').addEventListener('click', () => saveConfig());
    
    document.getElementById('master-pause').addEventListener('click', () => toggleControl('all', 'pause'));
    document.getElementById('master-resume').addEventListener('click', () => toggleControl('all', 'resume'));
    document.getElementById('refresh-coin-list').addEventListener('click', refreshCoinList);
    document.getElementById('refresh-balance').addEventListener('click', refreshBalance);
});
</script>
</body>
</html>
